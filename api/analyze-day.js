export default async function handler(req, res) {
  console.log('üîµ API –≤—ã–∑–≤–∞–Ω');
  console.log('üîµ –ï—Å—Ç—å –∫–ª—é—á?', !!process.env.CLAUDE_API_KEY);
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { dayData } = req.body;
  console.log('üîµ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', dayData);

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': process.env.CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 500,
        messages: [{
          role: 'user',
          content: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¶–æ–ª—å–∫–∏–Ω—É –∏ —Å–∏—Å—Ç–µ–º–µ 13-–ª—É–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∏—Å—Ö–æ–¥—è –∏–∑ —ç–Ω–µ—Ä–≥–∏–∏ –ö–∏–Ω–∞, –¢–æ–Ω–∞ –∏ –ü–µ—á–∞—Ç–∏.
                    –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã:
                    1. –°–æ—á–µ—Ç–∞—Ç—å –ø–æ—ç—Ç–∏—á–Ω–æ—Å—Ç—å –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤ —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏–µ–π.
                    2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é: "–ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è", "–í–µ–¥—É—â–∞—è —Å–∏–ª–∞", "–ê–Ω—Ç–∏–ø–æ–¥", "–û–∫–∫—É–ª—å—Ç–Ω—ã–π —É—á–∏—Ç–µ–ª—å".
                    3. –§–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ "–í–æ–ª–Ω–µ" (13-–¥–Ω–µ–≤–Ω–æ–º —Ü–∏–∫–ª–µ) –∫–∞–∫ –Ω–∞ –µ–¥–∏–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ.
                   –°—Ö–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞:
                   - –¢–æ–Ω: –ö–∞–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å (–æ—Ç –µ–¥–∏–Ω–∏—Ü—ã "–¶–µ–ª—å" –¥–æ —Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç–∏ "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ").
                   - –ü–µ—á–∞—Ç—å: –ö–∞–∫—É—é —ç–Ω–µ—Ä–≥–∏—é –≤–æ–ø–ª–æ—Ç–∏—Ç—å (—Ü–≤–µ—Ç –∏ —Å–∏–º–≤–æ–ª).
                   - –°–∏–Ω—Ç–µ–∑: –ö–∞–∫ —Å–≤—è–∑–∞—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–º–µ—Ç–∫—É) —Å —Ç–µ–∫—É—â–∏–º –ö–∏–Ω–æ–º.

–î–∞–Ω–Ω—ã–µ –¥–Ω—è:
- –¢–æ–Ω: ${dayData.tone}
- –ü–µ—á–∞—Ç—å: ${dayData.seal}
- –≠–Ω–µ—Ä–≥–∏—è: ${dayData.energy}
- –†–µ–∑–æ–Ω–∞–Ω—Å —Å –ø–µ—á–∞—Ç—å—é: ${dayData.resonance}
- –î–µ–ª–∞—Ç—å –∏–ª–∏ –±—ã—Ç—å: ${dayData.action}
- –°—Ç–∞–¥–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ${dayData.project}
- –ö–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ: ${dayData.insight}
- –ó–∞–º–µ—Ç–∫–∏: ${dayData.notes || '–Ω–µ—Ç'}

–î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö.`
        }]
      })
    });

    console.log('üîµ –°—Ç–∞—Ç—É—Å –æ—Ç Claude:', response.status);
    const data = await response.json();
    console.log('üîµ –û—Ç–≤–µ—Ç Claude:', data);
    
    const advice = data.content[0].text;
    res.status(200).json({ advice });
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
    res.status(500).json({ error: error.message });
  }
}