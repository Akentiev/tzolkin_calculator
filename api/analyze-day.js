export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { dayData } = req.body;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': process.env.CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-3-5-sonnet-20240620', // –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å
        max_tokens: 800,
        temperature: 0.5, // –°–Ω–∏–∂–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
        messages: [{
          role: 'user',
          content: `–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ –∫–æ—É—á, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π —Å–∏—Å—Ç–µ–º—É –¶–æ–ª—å–∫–∏–Ω –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏. 
          –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –¥–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–Ω—è, –∏–∑–±–µ–≥–∞—è –ª–∏—à–Ω–µ–π –º–∏—Å—Ç–∏–∫–∏, "–º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–ª—à–µ–±—Å—Ç–≤–∞" –∏ —Ä–∞–∑–º—ã—Ç—ã—Ö —Ñ—Ä–∞–∑.

          –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
          1. –ò—Å–ø–æ–ª—å–∑—É–π —á–µ—Ç–∫—É—é Markdown-—Ä–∞–∑–º–µ—Ç–∫—É (–∑–∞–≥–æ–ª–æ–≤–∫–∏, –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç, —Å–ø–∏—Å–∫–∏).
          2. –¢–æ–Ω: –¥–µ–ª–æ–≤–æ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π.
          3. –ü–µ—Ä–µ–≤–æ–¥–∏ —Å–∏–º–≤–æ–ª–∏–∑–º –ø–µ—á–∞—Ç–µ–π –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–º–µ—Å—Ç–æ "–ø–ª—ã—Ç—å –≤ –ø–æ—Ç–æ–∫–µ" –ø–∏—à–∏ "–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏").
          4. –°–æ–æ—Ç–Ω–æ—Å–∏ "–ó–∞–º–µ—Ç–∫–∏" –∏ "–°—Ç–∞–¥–∏—é –ø—Ä–æ–µ–∫—Ç–∞" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ –¥–Ω—è.

          –î–ê–ù–ù–´–ï –î–ù–Ø:
          - –¢–æ–Ω: ${dayData.tone}
          - –ü–µ—á–∞—Ç—å: ${dayData.seal}
          - –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —ç–Ω–µ—Ä–≥–∏—è ${dayData.energy}, —Ä–µ–∑–æ–Ω–∞–Ω—Å ${dayData.resonance}
          - –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${dayData.action} (–î–µ–ª–∞—Ç—å/–ë—ã—Ç—å)
          - –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞: ${dayData.project}
          - –ì–ª–∞–≤–Ω–æ–µ –∑–∞ –¥–µ–Ω—å: ${dayData.insight}
          - –õ–∏—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏: ${dayData.notes || '–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'}

          –°–¢–†–£–ö–¢–£–†–ê –í–´–•–û–î–ê (—Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –µ–π):
          ### üìä –í–µ–∫—Ç–æ—Ä –¥–Ω—è: [–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—á–∞—Ç–∏ –∏ —Ç–æ–Ω–∞]
          [–ö—Ä–∞—Ç–∫–∞—è —Å—É—Ç—å –¥–Ω—è –∫–∞–∫ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ‚Äî 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ]

          ### üß† –ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
          [–°–≤—è–∂–∏ "–ö–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ" –∏ "–°—Ç–∞–¥–∏—é –ø—Ä–æ–µ–∫—Ç–∞" —Å —ç–Ω–µ—Ä–≥–∏–µ–π –¥–Ω—è. –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —Å–µ–≥–æ–¥–Ω—è —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏–ª–∏ –∫–∞–∫ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.]

          ### üõ† –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          * **–§–æ–∫—É—Å:** (–Ω–∞ —á–µ–º —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –≤ —Ä–∞–±–æ—Ç–µ)
          * **–î–µ–π—Å—Ç–≤–∏–µ:** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–æ–Ω–∞)
          * **–í–Ω–∏–º–∞–Ω–∏–µ:** (–Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –≤ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º –ø–ª–∞–Ω–µ)

          ### üéØ –í–æ–ø—Ä–æ—Å –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
          [–û–¥–∏–Ω —Å–∏–ª—å–Ω—ã–π –∫–æ—É—á–∏–Ω–≥–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –Ω–∞ –∑–∞–≤—Ç—Ä–∞]`
        }]
      })
    });

    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error?.message || '–û—à–∏–±–∫–∞ API');
    }

    const advice = data.content[0].text;
    res.status(200).json({ advice });
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
    res.status(500).json({ error: error.message });
  }
}