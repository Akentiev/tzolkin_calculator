export default async function handler(req, res) {
  console.log('üîµ API –≤—ã–∑–≤–∞–Ω');
  console.log('üîµ –ï—Å—Ç—å –∫–ª—é—á?', !!process.env.CLAUDE_API_KEY);

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { dayData, mode, userProfile } = req.body;
  console.log('üîµ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', dayData, '–†–µ–∂–∏–º:', mode, '–ü—Ä–æ—Ñ–∏–ª—å:', !!userProfile);

  try {
    let systemPrompt, maxTokens;

    if (mode === 'structure') {
      // –†–µ–∂–∏–º —Å–µ–∫—Ä–µ—Ç–∞—Ä—è: —É–ø–∞–∫–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ JSON
      maxTokens = 300;
      systemPrompt = `–¢—ã ‚Äî —É–ø–∞–∫–æ–≤—â–∏–∫ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–∏–π JSON:
{"ai_summary": "–æ–¥–Ω–∞ —Ñ—Ä–∞–∑–∞-–∑–∞–≥–æ–ª–æ–≤–æ–∫", "ai_events": ["—Å–æ–±—ã—Ç–∏–µ 1", "—Å–æ–±—ã—Ç–∏–µ 2"]}

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞. –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω.

–î–ê–ù–ù–´–ï –î–ù–Ø:
- –¢–æ–Ω: ${dayData.tone}
- –ü–µ—á–∞—Ç—å: ${dayData.seal}
- –≠–Ω–µ—Ä–≥–∏—è: ${dayData.energy}/5
- –†–µ–∑–æ–Ω–∞–Ω—Å: ${dayData.resonance}
- –°—Ç—Ä–∞—Ç–µ–≥–∏—è: ${dayData.action}
- –ü—Ä–æ–µ–∫—Ç: ${dayData.project}
- –°–æ–±—ã—Ç–∏–µ: ${dayData.insight}
- –ó–∞–º–µ—Ç–∫–∏: ${dayData.notes || '–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'}

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON, –±–µ–∑ markdown, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.`;
    } else {
      // –†–µ–∂–∏–º –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞: —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑ —Å –≥–ª—É–±–æ–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π
      maxTokens = 1000;

      // –ú–∞–ø–ø–∏–Ω–≥ –ø–µ—á–∞—Ç–µ–π –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
      const sealNames = [
        '–ö—Ä–∞—Å–Ω—ã–π –î—Ä–∞–∫–æ–Ω', '–ë–µ–ª—ã–π –í–µ—Ç–µ—Ä', '–°–∏–Ω—è—è –ù–æ—á—å', '–ñ–µ–ª—Ç–æ–µ –°–µ–º—è',
        '–ö—Ä–∞—Å–Ω–∞—è –ó–º–µ—è', '–ë–µ–ª—ã–π –°–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å', '–°–∏–Ω—è—è –†—É–∫–∞', '–ñ–µ–ª—Ç–∞—è –ó–≤–µ–∑–¥–∞',
        '–ö—Ä–∞—Å–Ω–∞—è –õ—É–Ω–∞', '–ë–µ–ª–∞—è –°–æ–±–∞–∫–∞', '–°–∏–Ω—è—è –û–±–µ–∑—å—è–Ω–∞', '–ñ–µ–ª—Ç—ã–π –ß–µ–ª–æ–≤–µ–∫',
        '–ö—Ä–∞—Å–Ω—ã–π –°—Ç—Ä–∞–Ω–Ω–∏–∫', '–ë–µ–ª—ã–π –ú–∞–≥', '–°–∏–Ω–∏–π –û—Ä–µ–ª', '–ñ–µ–ª—Ç—ã–π –í–æ–∏–Ω',
        '–ö—Ä–∞—Å–Ω–∞—è –ó–µ–º–ª—è', '–ë–µ–ª–æ–µ –ó–µ—Ä–∫–∞–ª–æ', '–°–∏–Ω—è—è –ë—É—Ä—è', '–ñ–µ–ª—Ç–æ–µ –°–æ–ª–Ω—Ü–µ'
      ];

      // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ª–∏—á–Ω–æ–≥–æ –¥–Ω—è
      const calculatePersonalDay = (birthDate, currentDate) => {
        if (!birthDate) return null;

        const birth = new Date(birthDate + 'T00:00:00');
        const current = new Date(currentDate + 'T00:00:00');

        const currentDay = current.getDate();
        const currentMonth = current.getMonth() + 1;
        const birthDay = birth.getDate();

        const sumDigits = (n) => {
          return n.toString().split('').reduce((a, b) => a + parseInt(b), 0);
        };

        const dateSum = sumDigits(currentDay) + sumDigits(currentMonth);
        const consciousness = userProfile?.syucai?.consciousness || sumDigits(birthDay);

        let personalDay = dateSum + consciousness;
        while (personalDay > 9) {
          personalDay = sumDigits(personalDay);
        }

        return personalDay;
      };

      // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
      if (userProfile && userProfile.birthDate && userProfile.tzolkinBirth && userProfile.syucai) {
        const birthSealName = sealNames[userProfile.tzolkinBirth.seal] || `–ü–µ—á–∞—Ç—å ${userProfile.tzolkinBirth.seal}`;
        const currentSealName = dayData.seal || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–µ—á–∞—Ç—å';
        const personalDay = calculatePersonalDay(userProfile.birthDate, new Date().toISOString().split('T')[0]);

        systemPrompt = `–¢—ã ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –∫–æ—É—á, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∏–Ω—Ç–µ–∑—É –¶–æ–ª—å–∫–∏–Ω (–º–∞–π—è–Ω—Å–∫–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å) –∏ –°—é—Ü–∞–π (–∫–∏—Ç–∞–π—Å–∫–∞—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è).

**–î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:**
- –ò–º—è: ${userProfile.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
- –ö–∏–Ω —Ä–æ–∂–¥–µ–Ω–∏—è: ${userProfile.tzolkinBirth.kin} ‚Äî ${birthSealName} (–¢–æ–Ω ${userProfile.tzolkinBirth.tone})
- –°—é—Ü–∞–π: –ß–∏—Å–ª–æ –°–æ–∑–Ω–∞–Ω–∏—è ${userProfile.syucai.consciousness}, –ß–∏—Å–ª–æ –ú–∏—Å—Å–∏–∏ ${userProfile.syucai.mission}

**–ö–û–ù–¢–ï–ö–°–¢ –°–ï–ì–û–î–ù–Ø–®–ù–ï–ì–û –î–ù–Ø:**
- –¢–µ–∫—É—â–∏–π –ö–∏–Ω: ${currentSealName} (–¢–æ–Ω ${dayData.tone})
- –≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è: ${dayData.energy}/5
- –õ–∏—á–Ω—ã–π –¥–µ–Ω—å –ø–æ –°—é—Ü–∞–π: ${personalDay}
- –†–µ–∑–æ–Ω–∞–Ω—Å —Å –ø–µ—á–∞—Ç—å—é: ${dayData.resonance}
- –°—Ç—Ä–∞—Ç–µ–≥–∏—è: ${dayData.action} (–î–µ–ª–∞—Ç—å/–ë—ã—Ç—å)
- –°—Ç–∞–¥–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ${dayData.project}
- –ö–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ: ${dayData.insight}

**–ó–ê–ú–ï–¢–ö–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:** 
"${dayData.notes || '–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'}"

**–ó–ê–î–ê–ß–ê:**
–î–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–Ω—Ç–µ–∑–∞ —ç—Ç–∏—Ö —Å–∏—Å—Ç–µ–º.

–ö–∞–∫ —á–µ–ª–æ–≤–µ–∫—É —Å:
- –ú–∏—Å—Å–∏–µ–π ${userProfile.syucai.mission}
- –≠–Ω–µ—Ä–≥–∏–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è ${birthSealName}
- –õ–∏—á–Ω—ã–º –¥–Ω—ë–º ${personalDay}

...–ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è (${currentSealName}, –¢–æ–Ω ${dayData.tone})?

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ä–µ–∑–æ–Ω–∞–Ω—Å—ã**:
1. –ú–µ–∂–¥—É –ö–∏–Ω–æ–º –¥–Ω—è (${currentSealName}) –∏ –ö–∏–Ω–æ–º —Ä–æ–∂–¥–µ–Ω–∏—è (${birthSealName})
2. –ú–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –¢–æ–Ω–æ–º ${dayData.tone} –∏ –ß–∏—Å–ª–æ–º –°–æ–∑–Ω–∞–Ω–∏—è ${userProfile.syucai.consciousness}
3. –ú–µ–∂–¥—É –ª–∏—á–Ω—ã–º –¥–Ω—ë–º ${personalDay} –∏ –ß–∏—Å–ª–æ–º –ú–∏—Å—Å–∏–∏ ${userProfile.syucai.mission}

**–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (Markdown):**
### –†–µ–∑–æ–Ω–∞–Ω—Å –¥–Ω—è —Å –≤–∞—à–µ–π –ø—Ä–∏—Ä–æ–¥–æ–π
[–ö–∞–∫ —ç–Ω–µ—Ä–≥–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è —Å–æ–æ—Ç–Ω–æ—Å—è—Ç—Å—è —Å –≤–∞—à–∏–º –ö–∏–Ω–æ–º —Ä–æ–∂–¥–µ–Ω–∏—è –∏ –°—é—Ü–∞–π]

### –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π —Ñ–æ–∫—É—Å
[–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å —É—á—ë—Ç–æ–º –≤–∞—à–µ–π –ú–∏—Å—Å–∏–∏ ${userProfile.syucai.mission}]

### –¢–æ—á–∫–∞ –≤–Ω–∏–º–∞–Ω–∏—è
[–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–ª–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è]

### –í–æ–ø—Ä–æ—Å –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
[–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—É—á–∏–Ω–≥–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å]

–ò–∑–±–µ–≥–∞–π —ç–∑–æ—Ç–µ—Ä–∏–∫–∏. –ü–∏—à–∏ –¥–µ–ª–æ–≤—ã–º —è–∑—ã–∫–æ–º. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏.`;
      } else {
        // Fallback –¥–ª—è —Å–ª—É—á–∞—è –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è
        systemPrompt = `–¢—ã ‚Äî –∫–æ—É—á –ø–æ –¶–æ–ª—å–∫–∏–Ω—É. –î–∞–π –≥–ª—É–±–æ–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –¥–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ö–∏–Ω–∞, –≠–Ω–µ—Ä–≥–∏–∏ –∏ –∑–∞–º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ò—Å–ø–æ–ª—å–∑—É–π Markdown: –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ —Å–ø–∏—Å–∫–∏. –ò–∑–±–µ–≥–∞–π —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–æ–≥–æ —à—É–º–∞.
–¢–æ–Ω: –¥–µ–ª–æ–≤–æ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π.
–ü–µ—Ä–µ–≤–æ–¥–∏ —Å–∏–º–≤–æ–ª–∏–∑–º –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏/–ø–∏–∫—Ç–æ–≥—Ä–∞–º–º—ã/–∏–∫–æ–Ω–∫–∏.

–î–ê–ù–ù–´–ï –î–ù–Ø:
- –¢–æ–Ω: ${dayData.tone}
- –ü–µ—á–∞—Ç—å: ${dayData.seal}
- –≠–Ω–µ—Ä–≥–∏—è: ${dayData.energy}/5
- –†–µ–∑–æ–Ω–∞–Ω—Å: ${dayData.resonance}
- –°—Ç—Ä–∞—Ç–µ–≥–∏—è: ${dayData.action} (–î–µ–ª–∞—Ç—å/–ë—ã—Ç—å)
- –ü—Ä–æ–µ–∫—Ç: ${dayData.project}
- –°–æ–±—ã—Ç–∏–µ: ${dayData.insight}
- –ó–∞–º–µ—Ç–∫–∏: ${dayData.notes || '–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç'}

–°–¢–†–£–ö–¢–£–†–ê:
### –í–µ–∫—Ç–æ—Ä –¥–Ω—è: [–ü–µ—á–∞—Ç—å –∏ —Ç–æ–Ω]
[–°—É—Ç—å –¥–Ω—è ‚Äî 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ]

### –ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
[–°–≤—è–∑—å —Å–æ–±—ã—Ç–∏—è/–ø—Ä–æ–µ–∫—Ç–∞ —Å —ç–Ω–µ—Ä–≥–∏–µ–π –¥–Ω—è]

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
* **–§–æ–∫—É—Å:** (–Ω–∞ —á–µ–º —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è)
* **–î–µ–π—Å—Ç–≤–∏–µ:** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥)
* **–í–Ω–∏–º–∞–Ω–∏–µ:** (—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å–ø–µ–∫—Ç)

### –í–æ–ø—Ä–æ—Å –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
[–ö–æ—É—á–∏–Ω–≥–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å]`;
      }
    }

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': process.env.CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: maxTokens,
        temperature: mode === 'structure' ? 0.3 : 0.5,
        messages: [{
          role: 'user',
          content: systemPrompt
        }]
      })
    });

    console.log('üîµ –°—Ç–∞—Ç—É—Å –æ—Ç Claude:', response.status);
    const data = await response.json();
    console.log('üîµ –û—Ç–≤–µ—Ç Claude:', data);

    const result = data.content[0].text;

    if (mode === 'structure') {
      // –ü–∞—Ä—Å–∏–º JSON –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      try {
        const parsed = JSON.parse(result);
        res.status(200).json({
          ai_summary: parsed.ai_summary || '',
          ai_events: parsed.ai_events || []
        });
      } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
        res.status(200).json({
          ai_summary: result.substring(0, 200),
          ai_events: []
        });
      }
    } else {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º Markdown –∫–∞–∫ –µ—Å—Ç—å
      res.status(200).json({ advice: result });
    }

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
    res.status(500).json({ error: error.message });
  }
}